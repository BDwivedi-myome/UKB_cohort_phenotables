---
title: "Generate Chronic Kidney Disease (CKD) Phenotype Table"
subtitle: "Selected CKD Variables in UKBiobank"
author: "Bhakti Dwivedi"
date: '`r format.Date(Sys.time(), "%B %d %Y %H:%M", usetz = TRUE)`'
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cerulean
    highlight: tango
    fig_caption: no
    code_folding: show
    number_sections: true
---

```{r include = FALSE}
rm(list = grep("params", ls(all.names = TRUE), invert = TRUE, value = TRUE))
invisible(gc())
startTime <- Sys.time()
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
knitr::knit_engines$set(asis = function(options){
  if(options$echo && options$eval) knit_chold(text = options$code)
})
```

```{r load R packages}
pkgs <- c("tidyr", "dplyr", "tibble", "readr", "ggpubr", "knitr", "kableExtra", "stringdist", "jsonvalidate", "jsonlite", "tidyjson", "purrr", "ggplot2", "reticulate")
notFound <- pkgs[!(pkgs %in% installed.packages()[, "Package"])]
if(length(notFound)) install.packages(notFound)

library(tidyr)
library(dplyr)
library(tibble)
library(readr)
library(ggpubr)
library(knitr)
library(kableExtra)
library(stringdist)
library(jsonlite)
library(purrr)
library(ggplot2)
library(jsonvalidate)
library(reticulate)
```

```{r funcs}
#py_install("pyyaml")
#py_install("tableschema")
#py_install("/home/monika/projects/ascvd/dist/myome.ascvd-0.0.3.tar.gz")
# converts pickle files to rda 
## source_python("/home/bhakti/projects/repos/code/funcs/generate_rda.R")
```

```{r set dir and files}
output.dir <- "/home/bhakti/projects/repos/results/"
input.dir <-  "/home/bhakti/projects/repos/datasets/" # converted Rda object from pickle files
new.tbl <- "/home/bhakti/projects/repos/results/UKB_CKD_phenotype_BD.csv"
prev.tbl <- "/home/monika/dnanexus/research_ukb_ARPA-H/UKB_CKD_phenotype.csv"
combined.tbl <- "/home/bhakti/projects/repos/results/UKB_CKD_phenotypes_combd.csv"
CKD_json_schema <- "/home/bhakti/projects/repos/schema/CKD_pheno_v2.json"
json_file_path <- "/home/bhakti/projects/repos/results/UKB_CKD_phenotypes_combd.json"
```

# Objective
Process and Format phenotype data from UKBiobank for the chronic kidney disease (CKD) polygenic risk score prediction

# Data Processing
+ Extract the data fields of interest for instance `(i=0)` from the pickle formatted files
+ Reformat and define the clinical variables as requested
+ Generate CKD phenotype table in CSV and JSON format
+ Validate the final JSON table with the expected CKD phenotype JSON schema

## Input Datasets
+ Pickle formatted files including variables of interest was generated by Monika Sun from raw UKBiobank dataset via DNAnexus platform
+ Please see `DF_extraction` excel-sheet for variables (coding = 1) pulled on May 31st 2024. Variables (coding=0) already existed from before, hence not extracted
+ Files are located under "/myome/share/ukb/dnanexus/datasets/

## Data Fields of Interest
+ Please see `CKD_phenotype_variables_BD` excel documentation for following sheets:
  - `CKD_PhenoTable`: list of clinical variables of interest (i.e., UKBiobank data fields)
  - `DF_extraction`: variables extracted for the CKD study cohort

## Convert to and Validate JSON schema
+ use created yaml file as input
+ validate_schema.py provided my Monika

```{r convert yaml to json and validate table schema}
system("python /home/bhakti/projects/repos/code/funcs/validate_schema.py -sch /home/bhakti/projects/repos/schema/CKD_pheno_v2.yaml")
```

## Load Datasets
```{r get list of all rda files to read}

# name the resepctive rda files
age_vars_rda <- file.path(input.dir, "age_vars.Rda") #2GB file!
diag_vars_rda <- file.path(input.dir, "diagnosis_vars.Rda")
dreg_vars_rda <- file.path(input.dir, "dreg_vars.Rda")
smoke_vars_rda <- file.path(input.dir, "smoke_vars.Rda")
alc_vars_rda <- file.path(input.dir, "alc_vars.Rda")
phys_act_vars_rda <- file.path(input.dir, "phys_act_vars.Rda")
base_vars_rda <- file.path(input.dir, "base_vars.Rda")
pop_vars_rda <- file.path(input.dir, "pop_vars.Rda")
sysbp_vars_rda <- file.path(input.dir, "sysbp_vars.Rda")
diabp_vars_rda <- file.path(input.dir, "diabp_vars.Rda")
hb_vars_rda <- file.path(input.dir, "hb_vars.Rda")
trigly_vars_rda <- file.path(input.dir, "trigly_vars.Rda")
urate_vars_rda <- file.path(input.dir, "urate_vars.Rda")
urine_vars_rda <- file.path(input.dir, "urine_df.Rda")
meds_vars_rda <- file.path(input.dir, "meds_vars.Rda")
rel_vars_rda <- file.path(input.dir, "ukb_rel.Rda")

```

## Set parameters
```{r set params}
umolL_to_mgdL = 0.0113
mmolL_to_mgdL = 18
mgdL_to_mgL = 10
mgL_to_gL = (1/1000)

# race coding
eur = c(1, 1001, 1002, 1003)
afr = c(4, 4001, 4002, 4003)
sas = c(3001, 3002, 3003)
eas = c(5)
oth = c(2, 2001, 2002, 2003, 2004, 3, 3004, 6, -1, -3)

# disease diagnosis code
ic9 <- c(585, 5859)
ic10 <- c("N18", paste0("N18.", seq(from=0, to=5)), paste0("N18.", seq(from=8, to=9)))
hypt <- c(1065, 1072)
diab <- c(1220, 1222, 1223)
dyslip <- 1473
anemia <- c(1330, 1331, 1332, 1446)
cvd <- c(1066, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 1082)
chf <- 1076
pvd <- 1067

# medication/treatments for `p20003`
bptrt <- c("antihypertensive") # blood pressure
diamed <- c("oral hypoglycaemic","insulin product")
lipitrt <- "lipid lowering drug"
urictrt <- c("probenecid","sulfinpyrazone","allopurinol")

# medication/treatments for `p6153` and `p6177`
cholmed <- "Cholesterol lowering medication"
insumed <- "Insulin"
bpmed <- "Blood pressure medication"

# Define outcome binary coding (where-ever applicable)
cond_true = "1"
cond_false = "0"
missing_val = "nan"

```



## Process and transform data


### Baseline characterstics

#### Age/Sex/BMI
+ `p34` for year of birth
+ `p52` for month of birth
+ `p21022` for age at recruitment
+ `p31` for Sex (0=female; 1=male)
+ `p21001` for Body Mass Index (BMI) in Kg/m2
  - Categorized into <=24.9 kg/m2 and >=25 kg/m2 groups

```{r base vars}
base_vars <- readRDS(base_vars_rda)
dim(base_vars)
bmi_cutoff = 25.0
  


sel_base_data <- base_vars %>% 
  select("eid", 
         grep("p34", names(.)),
         grep("p52", names(.)),
         grep("p21022", names(.)),
         grep("p31", names(.)),
         grep("p21001_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

base_tbl <- sel_base_data %>%
  mutate(sex = ifelse(p31 == 0, "F", "M"),
         age = p21022,
         yob = p34,
         mob = p52,
         bmi = ifelse(p21001_i0 == "NaN", missing_val, p21001_i0))
base_summary <- base_tbl %>%
  group_by(sex, bmi) %>%
  summarise(n=n(), min_age= min(age), max_age=max(age),
            min_bmi=min(p21001_i0), max_bmi=max(p21001_i0)) %>%
  ungroup()

base_summary
table(base_tbl$bmi, useNA="always")

```

#### Race
+ `p21000_i0` for ethnic background
+ Race defined as follows:
  - "EUR": [1, 1001, 1002, 1003],
  - "AFR": [4, 4001, 4002, 4003],
  - "SAS": [3001, 3002, 3003],
  - "EAS": [5],
  - "OTH": [2, 2001, 2002, 2003, 2004, 3, 3004, 6, -1, -3]

```{r base vars}
pop_vars <- readRDS(pop_vars_rda)
dim(pop_vars)
  
sel_pop_data <- pop_vars %>% 
  select("eid", 
         grep("p21000_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

pop_tbl <- sel_pop_data %>%
  mutate(race = case_when(p21000_i0 %in% eur ~ "EUR",
                          p21000_i0 %in% afr ~ "AFR",
                          p21000_i0 %in% sas ~ "SAS",
                          p21000_i0 %in% eas ~ "EAS",
                          p21000_i0 %in% oth ~ "OTH",
                          .default = missing_val),
         race_raw = p21000_i0,
         ancestry = ifelse(race == "AFR", 1, 0))

table(pop_tbl$race_raw, pop_tbl$race, useNA="always")


```


### Relatedness
+ Exclude subjects with kinship > 0.0884 
+ Note: eid `ID2` column is being used to tag relatedness
+ `1 = related` and `0 = not related`

```{r relatedness}
rel_vars <- readRDS(rel_vars_rda)
dim(rel_vars)
kinship_cutoff = 0.0884

rel_excl_eid <- rel_vars %>%
  filter(Kinship > kinship_cutoff) %>%
  pull(ID2) %>% unique() 

rel_no <- base_tbl %>%
  select(eid) %>%
  filter(!eid %in% rel_excl_eid) %>%
  mutate(relatedness = 0) 

rel_yes <- base_tbl %>%
  select(eid) %>%
  filter(eid %in% rel_excl_eid) %>%
  mutate(relatedness = 1)
  
rel_tbl <- rbind(rel_yes, rel_no)
table(rel_tbl$relatedness, useNA="always")

```


### Recruitment date
+ `p53_i0` for date of first attended center (i=0)
+ Initial date of attending assessment center

```{r recruitment date}
age_vars <- readRDS(age_vars_rda)
dim(age_vars)

sel_age_data <- age_vars %>% 
  select("eid", 
         grep("p53_i0", names(.)),
         grep("p54_i0", names(.)),
         grep("p21003_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

age_tbl <- sel_age_data %>%
  rename("rcdate" = p53_i0,
         "rcplace" = p54_i0,
         "rcage" = p21003_i0) %>%
  select(eid, rcdate, rcplace, rcage)

```


### Disease Diagnosis at initial Recruitment
+ p41270, 41271 are ICD9/10 diagnosis respectively
+ Included `(p20002_i0_*, p2443_i0, p6150_i0)`
+ Diagnosis (`p20002_i0_*`) at `instance i = 0`
  - Hypertension: `1065, 1072`
  - Diabetes: `1220-1223`
  - Dyslipidemia: `1473`
  - Hyperuricaemia: `none identified`
  - Anaemia: `1330, 1331, 1332, 1446`
  - Cardiovascular disease (CVD): `1066, 1074-1082`, 
  - Congestive Heart Failure (CHF): `1076`
  - Peripheral Vascular Disease (PVD): `1067`
+ Diagnosis (`p2443_i0`) 
  - Diabetes (yes): `1`
  - Diabetes (no): `0`
  - Do not know: `-1`
  - Prefer not to answer: `-3`
  - last two are counted towards `nan`
+ Diagnosis (`p6150_i0`) 
  - Heart attack, Angina, & stroke (CVD): `1, 2, 3`
  - High blood pressure (Hypertension): `4`
  - None of the above: `-7`
  - Prefer not to answer: `-3`
+ For each diagnosis category, subjects coded as 0(no), 1(yes), or missing(nan)
+ Disease diganosis true/false involving more than one data field criteria are determined based on and/or condition. 
  - if any of the data field is true, is assigned true, is any of the data field is false, is assigned false
  - Note: the nan cases in both or any data fields are counted towards false.
+ Diagnosis is counted for each subject (row) by each disease across all `p20002_i0_a*` columns, independent of the `array (a*)` within `i=0`
+ Note: Hyperuricemia diagnosis not identified in showcase
    
```{r process diagnosis vars}

diag_vars <- readRDS(diag_vars_rda)
dim(diag_vars)

sel_diag_data <- diag_vars %>% 
  select("eid", 
         grep("p20002_i0", names(.)),
         grep("p2443_i0", names(.)),
         grep("p6150_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

diag_tbl <- data.frame(eid = sel_diag_data$eid)
  
match_any <- function(row, codes) {
  as.character(as.numeric(any(row %in% codes)))
}

diag_tbl$p20002_hypt <- apply(sel_diag_data, 1, function(row) match_any(row, hypt))
diag_tbl$p20002_diab <- apply(sel_diag_data, 1, function(row) match_any(row, diab))
diag_tbl$p20002_dyslip <- apply(sel_diag_data, 1, function(row) match_any(row, dyslip))
diag_tbl$p20002_anemia <- apply(sel_diag_data, 1, function(row) match_any(row, anemia))
diag_tbl$p20002_cvd <- apply(sel_diag_data, 1, function(row) match_any(row, cvd))
diag_tbl$p20002_chf <- apply(sel_diag_data, 1, function(row) match_any(row, chf))
diag_tbl$p20002_pvd <- apply(sel_diag_data, 1, function(row) match_any(row, pvd))

sel_diag_data <- sel_diag_data %>%
  mutate(p2443_diab = case_when(p2443_i0 == 0 ~ cond_false,
                                p2443_i0 == 1 ~ cond_true,
                                p2443_i0 == -1 ~ missing_val,
                                p2443_i0 == -3 ~ missing_val,
                                .default = missing_val),
         p6150_hypt = case_when(grepl("4", p6150_i0) ~ cond_true,
                                  !grepl("4", p6150_i0) ~ cond_false,
                                  .default = missing_val),
         p6150_cvd = case_when(grepl("[1-3]", p6150_i0) ~ cond_true,
                              !grepl("[1-3]", p6150_i0) ~ cond_false,
                              .default = missing_val))

diag_tbl$p2443_diab <- sel_diag_data$p2443_diab
diag_tbl$p6150_hypt <- sel_diag_data$p6150_hypt
diag_tbl$p6150_cvd <- sel_diag_data$p6150_cvd

diag_tbl <- diag_tbl %>%
  mutate(DIAG_ANAEMIA = p20002_anemia,
         DIAG_DIAB = ifelse(p20002_diab == cond_true | p2443_diab == cond_true, cond_true, cond_false),
         DIAG_HYPT = ifelse(p20002_hypt == cond_true | p6150_hypt == cond_true, cond_true, cond_false),
         DIAG_DYSLIP = p20002_dyslip,
         DIAG_CVD = ifelse(p20002_cvd == cond_true | p6150_cvd == cond_true, cond_true, cond_false),
         DIAG_CHF = p20002_chf,
         DIAG_PVD = p20002_pvd)

gc()
```

```{r run diagnosis diagnostics}
diag_to_plot <- diag_tbl %>%
  select(eid, grep("DIAG_", names(.))) %>%
  gather(key=diagnosis, value=value, -eid) %>%
  mutate(value = factor(value, levels=c(1, 0))) %>%
  group_by(diagnosis, value) %>%
  summarise(n=n()) %>%
  ungroup()

p1 <- ggplot(diag_to_plot, aes(x=diagnosis, y = n, fill=value)) +
  geom_bar(stat="identity") + 
  theme_minimal() +
  theme(axis.text.x = element_text(face="plain", size=12, angle=45, vjust = 0.8),
        axis.text.y = element_text(face="plain", size=12),
        axis.title.x = element_text(face="bold", size=12),
        axis.title.y = element_text(face="bold", size=12),
        plot.title = element_text(hjust=0.5)) +
  scale_fill_discrete(name="Coding") +
  xlab("Underlying disease conditions") + ylab("Number of subjects") +
  ggtitle("UKB subjects with summary diagnosis")
p1

## breakdown
diag_to_plot <- diag_tbl %>%
  select(eid, p20002_diab, p2443_diab, p20002_hypt, p6150_hypt, p20002_cvd, p6150_cvd) %>%
  gather(key=diagnosis_bk, value=value, -eid) %>%
  mutate(value = factor(value, levels=c(1, 0)),
         DF = case_when(grepl("diab", diagnosis_bk) ~ "DIAG_DIAB",
                        grepl("hypt", diagnosis_bk) ~ "DIAG_HYPT",
                        grepl("cvd", diagnosis_bk) ~ "DIAG_CVD"),
         .default=missing_val) %>%
  group_by(DF, diagnosis_bk, value) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  filter(value == 1)

p2 <- ggplot(diag_to_plot, aes(x=DF, y = n, fill=diagnosis_bk)) +
  geom_bar(position="stack", stat="identity") + 
  theme_minimal() +
  theme(axis.text.x = element_text(face="plain", size=12, angle=45, vjust = 0.8),
        axis.text.y = element_text(face="plain", size=12),
        axis.title.x = element_text(face="bold", size=12),
        axis.title.y = element_text(face="bold", size=12),
        plot.title = element_text(hjust=0.5)) +
  scale_fill_discrete(name="Coding") +
  xlab("Underlying disease conditions") + ylab("Number of subjects") +
  ggtitle("UKB subjects with conditions from self-reported and/or doctor diagnosis")
p2

```


#### Diagnosis date from recruitment
+ `p21022` age at recruitment
+ `p20009_i0` interpolated age at which non-cancer illness diagnosed (`p20002_i0`)
  - average per subject is taken across all columns starting with `p20009_i0`
  - is it necessary to take average only for disease diagnosis of interest, i.e., by `a*` index?
+ `p2976_i0` age diabetes diagnosed (`p2443`)
+ `p2966_i0 ` age high blood pressure diagnosed (`p6150`)
+ coding as `-1` or `-3` is assigned missing value
+ Difference computed from age at each diagnosis category to age at recruitment
  - We would expect age of diagnosis to be before or at recruitment age
  - age difference ~ 0.9 for `p20009_i0`
  - age difference ~ 20 or 25 (`p2966_i0`) outliers i.e., age diagnosed more than age at recruitment
+ Note: this is for QC; not adding this field to the final table


```{r diagnosis age}

selected_columns <- colnames(diag_age_vars[,grep("^p20009_i0", names(diag_age_vars))])

diag_age_vars <- age_vars %>%
  mutate(eid = as.numeric(eid),
         across(all_of(selected_columns), as.numeric)) %>%
  left_join(base_tbl, by="eid") %>%
  select(eid,
         age,
         grep("p20009_i0", names(.)),
         grep("p2976_i0", names(.)),
         grep("p2966_i0", names(.)))

diag_age_vars[diag_age_vars == -3] <- NA
diag_age_vars[diag_age_vars == -1] <- NA

diag_age_vars$diag_age_avg <- round(rowMeans(diag_age_vars[grep("^p20009_i0", names(diag_age_vars))], na.rm=TRUE), digits=1)

diag_age_tbl <- diag_age_vars %>%
  mutate(diab_age = as.numeric(p2976_i0),
         hypt_age = as.numeric(p2966_i0)) %>%
  select(eid, age, diag_age_avg, diab_age, hypt_age) %>%
  gather(key=age, value=value, -eid) %>%
  filter(value != "NaN" | !is.na(value))

ggplot(diag_age_tbl, aes(x = value, fill = age)) + geom_density(alpha = 0.5)

## check for age at diagnosis and age at recruitment:
## time1 - time2
check_dates <- diag_age_tbl %>%
  mutate(diag_to_rc = ifelse(diag_age_min != "nan", diag_age_min - age, "nan"),
         diab_to_rc = ifelse(diab_age != "nan", diab_age - age, "nan"),
         hypt_to_rc = ifelse(hypt_age != "nan", hypt_age - age, "nan"))


plot(density(as.numeric(check_dates$diag_to_rc), na.rm=TRUE), ylab="Frequency", xlab="Age diff (p20002 - Recruitment)", main="non-cancer illness diagnosis")
plot(density(as.numeric(check_dates$diab_to_rc), na.rm=TRUE), ylab="Frequency", xlab="Age diff (p2443 - Recruitment)", main="diabetes diagnosis")
plot(density(as.numeric(check_dates$hypt_to_rc), na.rm=TRUE), ylab="Frequency", xlab="Age diff (p6150 - Recruitment)", main="High blood pressure diagnosis")
table(check_dates$diag_to_rc)
table(check_dates$diab_to_rc)
table(check_dates$hypt_to_rc)

dens <- apply(diag_age_tbl, 2, density)
ggplot(diag_age_tbl, aes(x = dens, fill = lines)) + geom_density(alpha=0.5)

```


### Death registry

+ 40007	Age at death
+ 40001	Underlying (primary) cause of death: ICD10
+ 40002	Underlying (secondary) cause of death: ICD10
+ 191	Date lost to follow-up
+ 20143	Date of last personal contact wit UK Biobank

```{r death registry}
dreg_vars <- readRDS(dreg_vars_rda)
dim(dreg_vars)

dreg_vars_data <- dreg_vars %>% 
  select("eid", 
         grep("p20116_i0", names(.)),
         grep("p6194_i0", names(.)),
         grep("p2897_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))



```

### Lifestyle and environment

#### Smoking status
+ `p20116_i0` to define smoking status:
  - smoker (currently smoker) or
  - non-smoker (have never smoked or smoked in the past)
  - Prefer not to answer or NA are assigned missing (nan)
- `p6194_i0` and `p2897_i0` to define age of quitting smoking for past smokers only
  - in case of ties, minimum age of quitting smoking is taken
- take difference between age at recuritment and age of quitting smoking

```{r smoking status}
smoke_vars <- readRDS(smoke_vars_rda)
dim(smoke_vars)

sel_smoke_data <- smoke_vars %>% 
  select("eid", 
         grep("p20116_i0", names(.)),
         grep("p6194_i0", names(.)),
         grep("p2897_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

smkn_tbl <- sel_smoke_data %>%
  mutate(smkn_new = factor(case_when(p20116_i0 == "Current" ~ "Smoker",
                                p20116_i0 == "Previous" ~ "Non-smoker",
                                p20116_i0 == "Never" ~ "Non-smoker",
                                p20116_i0 == "Prefer not to answer" ~ missing_val,
                                is.na(p20116_i0) ~ missing_val,
                                .default = missing_val),
                              levels = c("Smoker", "Non-smoker", missing_val)),
         smkn = factor(case_when(p20116_i0 == "Current" ~ "Current",
                                p20116_i0 == "Previous" ~ "Past",
                                p20116_i0 == "Never" ~ "Never",
                                p20116_i0 == "Prefer not to answer" ~ missing_val,
                                is.na(p20116_i0) ~ missing_val,
                                .default = missing_val),
                              levels = c("Never", "Current", "Past", missing_val)),
         p6194_i0 = ifelse(p6194_i0 == "Prefer not to answer" | p6194_i0 == "Do not know", missing_val, p6194_i0),
         p2897_i0 = ifelse(p2897_i0 == "Prefer not to answer"  | p2897_i0 == "Do not know", missing_val, p2897_i0),
         smkn_age = case_when(is.na(p6194_i0) & is.na(p2897_i0) ~ missing_val,
                                is.na(p6194_i0) & !is.na(p2897_i0) ~ p2897_i0,
                                !is.na(p6194_i0) & is.na(p2897_i0) ~ p6194_i0,
                                !is.na(p6194_i0) & !is.na(p2897_i0) ~ min(p6194_i0, p2897_i0),
                              .default = missing_val)) %>%
  left_join(age_tbl, by="eid") %>%
  mutate(smkn_past = ifelse((smkn == "Past" & smkn_age != missing_val), (rcage - as.numeric(smkn_age)), missing_val))

table(smkn_tbl$p20116_i0, smkn_tbl$smkn_new, useNA="always")
table(smkn_tbl$p20116_i0, smkn_tbl$smkn, useNA="always")
table(smkn_tbl$p6194_i0, smkn_tbl$smkn, useNA="always")
table(smkn_tbl$p2897_i0, smkn_tbl$smkn, useNA="always")
table(smkn_tbl$smkn_past, smkn_tbl$smkn, useNA="always")

```


#### Alcohol
+ `p1558_i0` frequency per week used to derive alcohol frequency per month:
  - non-frequent drinker (drinking < 10 days per month) or
  - frequent drinker (drinking >= 10 days per month)
  - Rest is assigned missing (nan)

```{r alcohol status}
alc_vars <- readRDS(alc_vars_rda)
dim(alc_vars)

sel_alc_data <- alc_vars %>% 
  select("eid", 
         grep("p1558_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

alc_tbl <- sel_alc_data %>%
  mutate(alc = factor(case_when(p1558_i0 == "Never" ~ "Non-frequent drinker",
                                 p1558_i0 == "Special occasions only" ~ "Non-frequent drinker",
                                 p1558_i0 == "One to three times a month" ~ "Non-frequent drinker",
                                 p1558_i0 == "Once or twice a week" ~ "Non-frequent drinker",
                                 p1558_i0 == "Three or four times a week" ~ "Frequent drinker",
                                 p1558_i0 == "Daily or almost daily" ~ "Frequent drinker",
                                 p1558_i0 == "Prefer not to answer" ~ missing_val,
                                 is.na(p1558_i0) ~ missing_val,
                                .default = missing_val),
                            levels = c("Frequent drinker", "Non-frequent drinker", missing_val)))
table(alc_tbl$p1558_i0, alc_tbl$alc, useNA="always")

```


#### Habitual Exerciser
+ Habitual Exerciser defined as: 30 mins or more per day
+ `p22040_i0` total MET minutes per week for all activity including walking, moderate and vigorous activity.
+ Here, we defined habitual exerciser as total MET activity divided by 7 days to estimate minutes per day on average

```{r alcohol status}
phy_act_vars <- readRDS(phys_act_vars_rda)
dim(phy_act_vars)
phy_time_cutoff = 30.0

sel_phy_data <- phy_act_vars %>% 
  select("eid", grep("p22040_i0", names(.))) %>% 
  mutate(eid = as.numeric(eid))

phy_tbl <- sel_phy_data %>%
  mutate(phys = factor(case_when( p22040_i0 == missing_val | is.na(p22040_i0) ~ missing_val,
                                  (p22040_i0/7) >= phy_time_cutoff ~ "Habitual exerciser",
                                  (p22040_i0/7) < phy_time_cutoff ~ "Non-habitual exerciser",
                       .default = missing_val),
                             levels = c("Habitual exerciser", "Non-habitual exerciser", missing_val)))

phy_summary <- phy_tbl %>%
  group_by(phys) %>%
  summarise(n=n(), min=min(p22040_i0), max=max(p22040_i0)) %>%
  ungroup()

phy_summary
table(phy_tbl$phys, useNA="always")

```


### Measurements

#### Blood Pressure
+ `p4079` & `p4080` Diastolic and Systolic blood pressure in mmHg
  - Systolic (>=140 mmHg)
  - Diastolic (>=90 mmHg)

```{r blood pressure}
sysbp_vars <- readRDS(sysbp_vars_rda)
diabp_vars <- readRDS(diabp_vars_rda)
dim(sysbp_vars)
dim(diabp_vars)

sysbp_cutoff = 140.0
diabp_cutoff = 90.0

sel_bp_data <- sysbp_vars %>% 
  left_join(diabp_vars, by="eid") %>%
  select("eid",
         grep("p4079_i0_avg", names(.)),
         grep("p4080_i0_avg", names(.))) %>%
  mutate(eid = as.numeric(eid))


bp_tbl <- sel_bp_data %>%
  mutate(p4079_i0_avg = ifelse(p4079_i0_avg == "NaN" | is.na(p4079_i0_avg), missing_val, p4079_i0_avg),
         p4080_i0_avg = ifelse(p4080_i0_avg == "NaN" | is.na(p4080_i0_avg), missing_val, p4080_i0_avg),
         bp = factor(case_when( (p4080_i0_avg == missing_val | p4079_i0_avg == missing_val) ~ missing_val,
                                (p4080_i0_avg >= sysbp_cutoff & p4079_i0_avg >= diabp_cutoff) ~ cond_true,
                                (p4080_i0_avg < sysbp_cutoff | p4079_i0_avg < diabp_cutoff) ~ cond_false,
                               .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)))
bp_summary <- bp_tbl %>%
  group_by(bp) %>%
  summarise(n=n(), min_sys=min(p4080_i0_avg), max_sys=max(p4080_i0_avg), min_disys=min(p4079_i0_avg), max_disys=max(p4079_i0_avg)) %>%
  ungroup()
bp_summary
table(bp_tbl$bp, useNA="always")

```

#### Haemoglobin
+ `p30020_i0` Heamoglobin concentration (g/dL)
  - `p30022_i0` assay date
+ Levels <= 10.0 g/dL considered as anemia
  - should this range vary based on sex?
+ Time difference in recruitment date to assay dates is low comparatively

```{r haemoglobin}
hb_vars <- readRDS(hb_vars_rda)
dim(hb_vars)
hb_cutoff = 10
  
sel_hb_data <- hb_vars %>% 
  select("eid",
         grep("p30020_i0", names(.)),
         grep("p30022_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

hb_tbl <- sel_hb_data %>%
  left_join(sel_age_data, by="eid") %>%
  mutate(p30020_i0 = ifelse(p30020_i0 == "NaN", missing_val, p30020_i0),
        hb = factor(case_when(p30020_i0 == missing_val ~ missing_val,
                              p30020_i0 <= hb_cutoff ~ cond_true,
                              p30020_i0 > hb_cutoff  ~ cond_false,
                              .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)),
         hb_days_from_recrt = difftime(p30022_i0, p53_i0, units="days"))

hp_summary <- hb_tbl %>%
  group_by(hb) %>%
  summarise(n=n(), min=min(p30020_i0), max=max(p30020_i0)) %>%
  ungroup()
hp_summary

table(hb_tbl$hb, useNA="always")

## check for assay acquisition dates and recruitment dates:
## time1 - time2
check_dates <- hb_tbl %>%
  left_join(age_tbl, by="eid") %>%
  mutate(hb_rc = difftime(p30022_i0, rcdate, units = "days"))
plot(density(as.numeric(check_dates$hb_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="Haemoglobin")

```

#### Uric acid
+ `p30880_i0` serume urate levels (umol/L)
  - serum uric acid level > 7.0 mg/dL
  - convert umol/L to mg/dL, multiply by 0.0113
  - `p30881_i0` assay date
+ Time difference in recruitment date to assay date is high

```{r serum urate}
urate_vars <- readRDS(urate_vars_rda)
dim(urate_vars)

urate_cutoff = 7.0

sel_urate_data <- urate_vars %>% 
  select("eid",
         grep("p30880_i0", names(.)),
         grep("p30881_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

uric_tbl <- sel_urate_data %>%
  mutate(p30880_i0_mgdL = p30880_i0 * umolL_to_mgdL,
         p30880_i0 = ifelse(p30880_i0 == "NaN", missing_val, p30880_i0),
         urate = factor(case_when(p30880_i0_mgdL == "NaN" ~ missing_val,
                                  p30880_i0_mgdL > urate_cutoff  ~ cond_true,
                                  p30880_i0_mgdL <= urate_cutoff  ~ cond_false,
                                  .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)))
uric_summary <- uric_tbl %>%
  group_by(urate) %>%
  summarise(n=n(), min=min(p30880_i0_mgdL), max=max(p30880_i0_mgdL)) %>%
  ungroup()
uric_summary
table(uric_tbl$urate, useNA="always")

## check for assay acquisition dates and recruitment dates:
## time1 - time2
check_dates <- uric_tbl %>%
  left_join(age_tbl, by="eid") %>%
  mutate(uric_rc = difftime(p30881_i0, rcdate, units = "days"))
plot(density(as.numeric(check_dates$uric_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="Serum Urate")

```

#### Lipids and Glucose
+ `p30870_i0` Triglycerides (mmol/L)
  - serum triglyerides >= 150 mg/dL
  - `p30871_i0` assay date
+ `p30780_i0` LDL cholesterol (mmol/L)
  - LDL >= 140 mg/dL
  - `p30781_i0` assay date
+ `p30760_i0` HDL cholesterol (mmol/L)
  - HDL < 40 mg/dL
  - `p30761_i0` assay date
+ `p30740_i0` Glucose (mmol/L)
  - fasting blood glucose > 126 mg/dL
  - `p30741_i0` assay date
+ `p30750_i0` Glycated haemoglobin (HbA1c) mmol/mol
  - need threshold for this criteria?
  - `p30751_i0` assay date
+ 1 mmol/L = 18 mg/dL, multiply by 18
+ For each measurement, subjects coded as 0(no), 1(yes), or missing(nan)
+ Time difference in recruitment date to assay dates is high
+ Time difference among measurments is zero with exceptions
  - do we not consider data points from such cases?
+ Time difference in Glucose & Glycated haemoglobin is high

```{r lipids and glucose}
trigly_vars <- readRDS(trigly_vars_rda)
dim(trigly_vars)

# cut-offs in mg/dL
trigly_cutoff = 150.0
ldl_cutoff = 140.0
hdl_cutoff = 40.0
glu_cutoff = 126.0

sel_lipids_data <- trigly_vars %>% 
  select("eid",
         grep("p30870_i0", names(.)),
         grep("p30871_i0", names(.)),
         grep("p30780_i0", names(.)),
         grep("p30781_i0", names(.)),
         grep("p30760_i0", names(.)),
         grep("p30761_i0", names(.)),
         grep("p30740_i0", names(.)),
         grep("p30741_i0", names(.)),
         grep("p30750_i0", names(.)),
         grep("p30751_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

lipd_tbl <- sel_lipids_data %>%
  mutate(p30870_i0_mgdL = p30870_i0 * mmolL_to_mgdL,
         p30780_i0_mgdL = p30780_i0 * mmolL_to_mgdL,
         p30760_i0_mgdL = p30760_i0 * mmolL_to_mgdL,
         p30740_i0_mgdL = p30740_i0 * mmolL_to_mgdL,
         
         p30870_i0 = ifelse(p30870_i0 == "NaN", missing_val, p30870_i0),
         p30780_i0 = ifelse(p30780_i0 == "NaN", missing_val, p30780_i0),
         p30760_i0 = ifelse(p30760_i0 == "NaN", missing_val, p30760_i0),
         p30740_i0 = ifelse(p30740_i0 == "NaN", missing_val, p30740_i0),
         p30750_i0 = ifelse(p30750_i0 == "NaN", missing_val, p30750_i0),
         
         trigly = factor(case_when(p30870_i0_mgdL == "NaN" ~ missing_val,
                                   p30870_i0_mgdL >= trigly_cutoff  ~ cond_true,
                                   p30870_i0_mgdL < trigly_cutoff  ~ cond_false,
                                   .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)),
         ldl = factor(case_when(p30780_i0_mgdL == "NaN" ~ missing_val,
                                p30780_i0_mgdL >= ldl_cutoff  ~ cond_true,
                                p30780_i0_mgdL < ldl_cutoff  ~ cond_false,
                                .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)),
         hdl = factor(case_when(p30760_i0_mgdL == "NaN" ~ missing_val,
                                p30760_i0_mgdL < hdl_cutoff  ~ cond_true,
                                p30760_i0_mgdL >= hdl_cutoff  ~ cond_false,
                                .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)),
         glu = factor(case_when(p30740_i0_mgdL == "NaN" ~ missing_val,
                                p30740_i0_mgdL > glu_cutoff  ~ cond_true,
                                p30740_i0_mgdL <= glu_cutoff  ~ cond_false,
                                .default = missing_val),
                             levels = c(cond_false, cond_true, missing_val)))

lipd_summary <- lipd_tbl %>%
  group_by(trigly, ldl, hdl, glu) %>%
  summarise(n=n(),
            min_tg=min(p30870_i0_mgdL), max_tg=max(p30870_i0_mgdL), 
            min_ldl=min(p30780_i0_mgdL), max_ldl=max(p30780_i0_mgdL),
            min_hdl=min(p30760_i0_mgdL), max_hdl=max(p30760_i0_mgdL),
            min_glu=min(p30740_i0_mgdL), max_glu=max(p30740_i0_mgdL)) %>%
  ungroup()
lipd_summary

table(lipd_tbl$trigly, useNA="always")
table(lipd_tbl$ldl, useNA="always")
table(lipd_tbl$hdl, useNA="always")
table(lipd_tbl$glu, useNA="always")

## check for assay acquisition dates and recruitment dates:
## check for assay acquisition dates among measurements
## time1 - time2
check_dates <- lipd_tbl %>%
  left_join(age_tbl, by="eid") %>%
  mutate(trigly_rc = difftime(p30871_i0, rcdate, units = "days"),
         ldl_rc = difftime(p30781_i0, rcdate, units = "days"),
         hdl_rc = difftime(p30761_i0, rcdate, units = "days"),
         glu_rc = difftime(p30741_i0, rcdate, units = "days"),
         gly_rc = difftime(p30751_i0, rcdate, units = "days"),
         
         trigly_ldl = difftime(p30871_i0, p30781_i0, units = "days"),
         ldl_hdl = difftime(p30781_i0, p30761_i0, units = "days"),
         ldl_glu = difftime(p30781_i0, p30741_i0, units = "days"),
         glu_gly = difftime(p30741_i0, p30751_i0, units = "days"))

plot(density(as.numeric(check_dates$trigly_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="Triglycerides")
plot(density(as.numeric(check_dates$ldl_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="LDL")
plot(density(as.numeric(check_dates$hdl_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="HDL")
plot(density(as.numeric(check_dates$glu_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="Glucose")
plot(density(as.numeric(check_dates$gly_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="Glycated haemoglobin")

barplot(table(check_dates$trigly_ldl))
barplot(table(check_dates$ldl_hdl))
barplot(table(check_dates$ldl_glu))
barplot(table(check_dates$glu_gly))


```

#### Creatinine and Microalbumin
+ `p30700_i0` Creatinine (umol/L) in blood
  - `p30701_i0` assay date
+ `p30500_i0` Microalbumin in urine (mg/L)
  - `p30502_i0` acquisition time
+ `p30510_i0` Creatinine (enzymatic) in urine (umol/L)
  - `p30512_i0` Creatinine (enzymatic) acquisition time
  - convert umol/L to g/L: 1 umol/L * 0.0113 mg/dL * 10mg/L * 1/1000 g/L
+ Time difference in recruitment date to assay date is high
+ Time difference in Urine CR & AB assay date is zero with exceptions
  - do we not consider data points from such cases?
+ Time difference in Urine CR & Blood CR assay dates is high

```{r lipids and glucose}
urine_vars <- readRDS(urine_vars_rda)
dim(urine_vars)

crab_tbl <- urine_vars %>% 
  select("eid",
         grep("p30700_i0", names(.)),
         grep("p30701_i0", names(.)),
         grep("p30500_i0", names(.)),
         grep("p30502_i0", names(.)),
         grep("p30510_i0", names(.)),
         grep("p30512_i0", names(.))) %>%
  mutate(eid = as.numeric(eid),
         p30510_i0_gL = (p30510_i0 * umolL_to_mgdL * mgdL_to_mgL * mgL_to_gL))


## check for assay acquisition dates and recruitment dates: Big... why?
## check for assay acquisition dates for Urine AB and Urine CR: should be none to minimal, say <=2 days?
check_dates <- crab_tbl %>%
  left_join(age_tbl, by="eid") %>%
  mutate(bl_cr_date_to_rc = difftime(p30701_i0, rcdate, units = "days"), # blood CR assay date from initial recruitment date
         ur_cr_date_to_rc = difftime(p30512_i0, rcdate, units = "days"), # Urine CR assay date from initial recruitment date
         ur_ab_date_to_rc = difftime(p30502_i0, rcdate, units = "days"), # Urine AB assay date from initial recruitment date
         ur_cr_ab_dates = difftime(p30512_i0, p30502_i0, units = "days"),
         ur_cr_bl_cr_dates = difftime(p30512_i0, p30701_i0, units = "days")) # Blood CR & Urine CR assay dates (time1 - time2)

plot(density(as.numeric(check_dates$ur_cr_date_to_rc), na.rm=TRUE), ylab="Frequency", xlab="Assay date - Recruitment Date", main="UrineCR")

# ranges from -7 to 6 with majority in 0 days difference
table(check_dates$ur_cr_ab_dates)
barplot(table(check_dates$ur_cr_ab_dates))
table(check_dates$ur_cr_bl_cr_dates)
barplot(table(check_dates$ur_cr_bl_cr_dates))
  
```


### UACR
+ urinary albumin-creatinine ratio
+ `p30500_i0` in mg/L / `p30510_i0` in g/L

```{r uacr}
uacr_tbl <- crab_tbl %>%
  mutate(UACR = (p30500_i0 / p30510_i0_gL)) %>%
  rename("CR" = p30700_i0, 
         "UrineAB" = p30500_i0,
         "UrineCR" = p30510_i0,
         "UrineCR_gL" = p30510_i0_gL) %>%
  select(eid, CR, UrineAB, UrineCR, UrineCR_gL, UACR)
hist(uacr_tbl$UACR)
min(uacr_tbl$UACR, na.rm=TRUE)
max(uacr_tbl$UACR, na.rm=TRUE)
median(uacr_tbl$UACR, na.rm=TRUE)
```


### eGFR
+ eGFR (glomerular filtration rate, creatinine base)
+ Calculated from UKB publication https://doi.org/10.1101/2022.06.16.22276246 equation based on Levey et. al. 2006 calculation [PMID:16908915]. Unforuntately don't have access to this publication. But found another reference for the equation https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2763564/. The multiplication factors for ancestry and sex seem like they are supposed to be multiple only if true, i.e. x1 if not female, x1.212 if female.
+ eGFR in mL/min per 1.73 m2 = 175 * (CR(serum) umol/L / 88.4)^ -1.154 * AGE(at assessment)^-0.203 * (ancestry1.212) * (sex0.742)

```{r egfr}

egfr_tbl <- uacr_tbl %>%
  left_join(base_tbl, by="eid") %>%
  left_join(pop_tbl, by="eid") %>%
  mutate(pt1 = (175 * (CR / 88.4) ** -1.154),
         pt2 = age ** -0.203,
         pt3 = ifelse(ancestry == 1, 1.212, 1),
         pt4 = ifelse(sex == "F", 0.742, 1),
         eGFR = pt1 * pt2 * pt3 * pt4) %>%
  select(eid, eGFR)

hist(egfr_tbl$eGFR)
min(egfr_tbl$eGFR, na.rm=TRUE)
max(egfr_tbl$eGFR, na.rm=TRUE)
median(egfr_tbl$eGFR, na.rm=TRUE)

```


### Medications and treatment
+ `p20003_i0` treatment/medication
  - antihypertensive agents (`1140888578`, `2`)
+ `p6177_i0` medication for cholesterol(1), blood pressure(2), or diabetes(3): males only
+ `p6153_i0` medication for cholesterol(1), blood pressure(2), or diabetes(3): females only
+ Medication true/false involving more than one data field criteria are determined based on and/or condition. 
  - if any of the data field is true, is assigned true, 
  - all data fields must be false to be assigned false

```{r medications}
meds_vars <- readRDS(meds_vars_rda)
dim(meds_vars)

sel_meds_data <- meds_vars %>% 
  select("eid",
         grep("p20003_i0", names(.)),
         grep("p6177_i0", names(.)),
         grep("p6153_i0", names(.))) %>%
  mutate(eid = as.numeric(eid))

trt_tbl <- data.frame(eid = sel_meds_data$eid)
  
match_any <- function(row, codes) {
  as.numeric(any(row %in% codes))
}
trt_tbl$p20003_bptrt <- apply(sel_meds_data, 1, function(row) match_any(row, bptrt))
trt_tbl$p20003_diamed <- apply(sel_meds_data, 1, function(row) match_any(row, diamed))
trt_tbl$p20003_lipitrt <- apply(sel_meds_data, 1, function(row) match_any(row, lipitrt))
trt_tbl$p20003_urictrt <- apply(sel_meds_data, 1, function(row) match_any(row, urictrt))

sel_meds_data <- sel_meds_data %>%
  mutate(p6177_p6153_lipitrt = case_when(grepl(cholmed, p6177_i0) | grepl(cholmed, p6153_i0) ~ cond_true,
                                 !grepl(cholmed, p6177_i0) & !grepl(cholmed, p6153_i0) ~ cond_false,
                                 .default = missing_val),
         p6177_p6153_diamed = case_when(grepl(insumed, p6177_i0) | grepl(insumed, p6153_i0) ~ cond_true,
                                 !grepl(insumed, p6177_i0) & !grepl(insumed, p6153_i0) ~ cond_false,
                                 .default = missing_val),
         p6177_p6153_bptrt = case_when(grepl(bpmed, p6177_i0) | grepl(bpmed, p6153_i0) ~ cond_true,
                                 !grepl(bpmed, p6177_i0) & !grepl(bpmed, p6153_i0) ~ cond_false,
                                 .default = missing_val))

trt_tbl$p6177_p6153_bptrt <- sel_meds_data$p6177_p6153_bptrt
trt_tbl$p6177_p6153_diamed <- sel_meds_data$p6177_p6153_diamed
trt_tbl$p6177_p6153_lipitrt <- sel_meds_data$p6177_p6153_lipitrt

trt_tbl <- trt_tbl %>%
  mutate(BPMED = case_when(p20003_bptrt == cond_true | p6177_p6153_bptrt == cond_true ~ cond_true,
                           p20003_bptrt == cond_false & p6177_p6153_bptrt == cond_false ~ cond_false),
         DIAMED = case_when(p20003_diamed == cond_true | p6177_p6153_diamed == cond_true ~ cond_true,
                            p20003_diamed == cond_false & p6177_p6153_diamed == cond_false ~ cond_false),
         LIPIMED = case_when(p20003_lipitrt == cond_true | p6177_p6153_lipitrt == cond_true ~ cond_true,
                             p20003_lipitrt == cond_false & p6177_p6153_lipitrt == cond_false ~ cond_false),
         URIMED = p20003_urictrt)      

table(trt_tbl$BPMED, useNA="always")
table(trt_tbl$DIAMED, useNA="always")
table(trt_tbl$LIPIMED, useNA="always")
table(trt_tbl$URIMED, useNA="always")

```


### Combine all datasets

```{r combine processed data}

combined_data <- diag_tbl %>%
  ##left_join(age_tbl, by="eid") %>% # includes in smkn_tbl
  left_join(pop_tbl, by="eid") %>%
  left_join(uacr_tbl, by="eid") %>%
  left_join(egfr_tbl, by="eid") %>%
  left_join(rel_tbl, by="eid") %>%
  left_join(base_tbl, by="eid") %>%
  left_join(smkn_tbl, by="eid") %>%
  left_join(alc_tbl, by="eid") %>%
  left_join(phy_tbl, by="eid") %>%
  left_join(hb_tbl, by="eid") %>%
  left_join(bp_tbl, by="eid") %>%
  left_join(uric_tbl, by="eid") %>%
  left_join(lipd_tbl, by="eid") %>%
  left_join(trt_tbl, by="eid")

```


### Underlying diseases based on definitions
+ Hypertension: under treatment with antihypertensive agents or blood pressure ≥ 140/90 mmHg
+ Diabetes: under treatment with oral hypoglycemic agents or insulin, or fasting blood glucose ≥ 126 mg/dL
+ Dyslipidemia: under treatment with lipid-lowering agents, serum triglycerides ≥ 150 mg/dL, serum low-density lipoprotein-cholesterol ≥ 140 mg/dL, or serum high-density lipoprotein-cholesterol < 40 mg/dL
+ under treatment with uric acid lowering agents or serum uric acid level > 7.0 mg/dL
+ Anemia, CVD, CHF, PVD are based on summary diagnosis only since no clear definition from study
+ Proteinuria is defined based on urine protein albumin to creatinine ratio

```{r underlying diseases}

all_table <- combined_data %>%
  mutate(hypertension = ifelse((BPMED == cond_true | bp == cond_true), cond_true, cond_false),
         diabetes = ifelse((DIAMED == cond_true | glu == cond_true), cond_true, cond_false),
         dyslipidemia = ifelse((LIPIMED == cond_true | trigly == cond_true | ldl == cond_true | hdl == cond_true), cond_true, cond_false),
         hyperuricemia = ifelse((URIMED == cond_true | urate == cond_true), cond_true, cond_false))

```

# Results 

## Generate Final Table
+ Select the column for the final phenotype table
+ Rename columns matching with the schema
+ save file as csv with columns as strings and quoted (Missing value must be "nan")

```{r final table}
new_tbl <- all_table %>%
  select(eid,
         bmi, # bmi
         smkn_new, smkn, smkn_past, alc, phys,
         p4080_i0_avg, p4079_i0_avg, # bp
         p30020_i0, # hb
         p30740_i0, # glu
         p30750_i0, # hba1c
         p30880_i0, # urate
         p30870_i0, #trigly
         p30780_i0, # ldl
         p30760_i0, # hdl
         BPMED, DIAMED, LIPIMED, URIMED,
         hypertension, diabetes, dyslipidemia, hyperuricemia,
         grep("diag_", names(.)),) %>%
  rename("SUBJID" = eid,
         "BMI" = "bmi",
         "SMOKING_NEW" = smkn_new,
         "SMOKING" = smkn,
         "SMOKING_PAST" = smkn_past,
         "ALCOHOL" = alc,
         "ACTIVITY" = phys,
         "SYSBP" = p4080_i0_avg,
         "DIABP" = p4079_i0_avg,
         "HB" = p30020_i0,
         "GLUCOSE" = p30740_i0,
         "HBA1C" = p30750_i0,
         "URATE" = p30880_i0,
         "TRIGLY" = p30870_i0,
         "LDL" = p30780_i0,
         "HDL" = p30760_i0,
         "BPMED" = BPMED,
         "DIABMED" = DIAMED,
         "URIMED" = URIMED,
         "LIPIMED" = LIPIMED,
         "HYPERTENSION" = hypertension,
         "DIABETES" = diabetes,
         "DYSLIPIDEMIA" = dyslipidemia,
         "HYPERURICEMIA" = hyperuricemia,
         "DIAG_ANAEMIA" = diag_anemia,
         "DIAG_DIAB" = diag_diab,
         "DIAG_HYPT" = diag_hypt,
         "DIAG_DYSLIP" = diag_dyslip,
         "DIAG_CVD" = diag_cvd,
         "DIAG_CHF" = diag_chf,
         "DIAG_PVD" = diag_pvd
         ) %>%
   mutate(across(everything(), as.character))
dim(new_tbl)
new_tbl[] <- lapply(new_tbl, function(x) {x[grepl("NaN", x)] <- "nan"; x})
write_csv(new_tbl, file=new.tbl, na="nan", quote = "all")
```

## Load existing CKD phenotable
+ Generated by Monika Sun
+ /home/monika/dnanexus/research_ukb_ARPA-H

```{r previous CKD phenotable}
prev_tbl <- read_csv(file=prev.tbl)
dim(prev_tbl)
prev_tbl[] <- lapply(prev_tbl, function(x) {x[grepl("NaN", x)] <- "nan"; x})
```

## Combine phenotables
+ by SUBJID
+ UACR estimation varies a. bit in decimal points, probably because of UrineCR_gL rounding.
+ save file as csv with columns as strings and quoted (Missing value must be "nan")

```{r merge tables}
new_prev_tbl <- prev_tbl %>% 
  full_join(new_tbl, by="SUBJID")
write_csv(new_prev_tbl, file=combined.tbl, na="nan", quote = "all")
```

## Phenotyle table Validation
```{r validate final tbl with json schema}
system("python /home/bhakti/projects/repos/code/funcs/validate_table.py -csv /home/bhakti/projects/repos/results/UKB_CKD_phenotypes_combd.csv -sch /home/bhakti/projects/repos/schema/CKD_pheno_v2.json")
```


## Diagnostics

# Diagnostics

```{r validation data field diagnostics}

# Diagnosis diagnostics
diag_to_plot <- new_prev_tbl %>%
  select(SUBJID, grep("DIAG_", names(.))) %>%
  gather(key=diagnosis, value=value, -SUBJID) %>%
  mutate(value = factor(value, levels=c(1, 0))) %>%
  group_by(diagnosis, value) %>%
  summarise(n=n()) %>%
  ungroup()

p <- ggplot(diag_to_plot, aes(x=diagnosis, y = n, fill=value)) +
  geom_bar(stat="identity") + 
  theme_minimal() +
  theme(axis.text.x = element_text(face="plain", size=12, angle=45, vjust = 0.8),
        axis.text.y = element_text(face="plain", size=12),
        axis.title.x = element_text(face="bold", size=12),
        axis.title.y = element_text(face="bold", size=12),
        plot.title = element_text(hjust=0.5)) +
  scale_fill_discrete(name="Coding") +
  xlab("Underlying disease conditions") + ylab("Number of subjects") +
  ggtitle("UKB subjects with conditions from self-reported and/or doctor diagnosis")
p

# Criteria defined based underlying disease
dis_to_plot <- all_table %>%
  select(eid, 
         bp,
         BPMED,
         hypertension,
         glu,
         DIAMED,
         diabetes,
         trigly,
         ldl, 
         hdl,
         LIPIMED,
         dyslipidemia,
         urate,
         URIMED,
         hyperuricemia) %>%
  gather(key=criteria, value=value, -eid) %>%
  mutate(criteria = factor(criteria, levels = c(
    "bp",
    "BPMED",
    "hypertension",
    "glu",
    "DIAMED",
    "diabetes",
    "trigly",
    "ldl", 
    "hdl",
    "LIPIMED",
    "dyslipidemia",
    "urate",
    "URIMED",
    "hyperuricemia"
  )),
  value = factor(value, levels=c(1, 0, "nan"))) %>%
  group_by(criteria, value) %>%
  summarise(n=n()) %>%
  ungroup()

p <- ggplot(dis_to_plot, aes(x=criteria, y = n, fill=value)) +
  geom_bar(stat="identity") + 
  theme_minimal() +
  theme(axis.text.x = element_text(face="plain", size=12, angle=45, vjust = 0.8),
        axis.text.y = element_text(face="plain", size=12),
        axis.title.x = element_text(face="bold", size=12),
        axis.title.y = element_text(face="bold", size=12),
        plot.title = element_text(hjust=0.5)) +
    scale_fill_discrete(name="Coding") +
    xlab("Defined disease conditions") + ylab("Number of subjects") +
    ggtitle("UKB subjects with conditions defined by study criteria")
p

# Distribution of measurements/numerical values
p <- ggplot(new_prev_tbl, aes(x=, fill="grey")) + geom_density(alpha=0.4)
p

# Add mean lines
p+geom_vline(data=mu, aes(xintercept=grp.mean, color=sex),
             linetype="dashed")


# Categorical variables
ggplot(read_comb_tbl, aes(x=SMOKING)) +
  geom_bar(stat="count", width=0.7, fill="steelblue")+
  theme_minimal()

ggplot(read_comb_tbl, aes(x=ALCOHOL))+
  geom_bar(stat="count", width=0.7, fill="steelblue")+
  theme_minimal()

ggplot(read_comb_tbl, aes(x=ACTIVITY))+
  geom_bar(stat="count", width=0.7, fill="steelblue")+
  theme_minimal()
```


Time to process this report: `r format(Sys.time() ~ startTime, digits = 1)`